<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webflow AI Alt Text Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast {
            animation: fade-in-out 3s ease-in-out forwards;
        }
        @keyframes fade-in-out {
            0%, 100% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Webflow AI Alt Text Generator</h1>
            <p class="text-gray-600 mt-2">Scan your Webflow sites for images missing alt text and generate it with AI.</p>
        </header>

        <!-- Main Content -->
        <main class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200">

            <!-- Step 1: Connection -->
            <div id="setup-section">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Step 1: Connect to Webflow</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label for="webflow-api-key" class="block text-sm font-medium text-gray-700 mb-1">Webflow API Key</label>
                        <input type="password" id="webflow-api-key" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter your Webflow API v2 Key">
                    </div>
                    <button id="connect-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out h-10">
                        Connect
                    </button>
                </div>
                 <div id="connection-status" class="mt-2 text-sm"></div>
            </div>

            <!-- Step 2: Site Selection & Scan -->
            <div id="site-selection-section" class="mt-8 hidden">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Step 2: Select Site & Scan</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label for="site-selector" class="block text-sm font-medium text-gray-700 mb-1">Select a Site</label>
                        <select id="site-selector" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" disabled>
                            <option>Connect to Webflow first</option>
                        </select>
                    </div>
                    <button id="scan-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out h-10" disabled>
                        Scan for Images
                    </button>
                </div>
            </div>

            <!-- Step 3: Results -->
            <div id="results-section" class="mt-8 hidden">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-3">Step 3: Generate Alt Text</h2>
                <div id="results-summary" class="mb-4 text-gray-600"></div>
                <div id="results-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <!-- Image cards will be injected here -->
                </div>
                 <div id="results-loader" class="flex justify-center items-center py-8 hidden">
                    <div class="loader"></div>
                    <p class="ml-4 text-gray-600">Scanning for images...</p>
                </div>
            </div>

        </main>
    </div>

    <!-- Modal for Alt Text Generation -->
    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all" id="modal-content">
            <div class="p-6">
                <h3 class="text-2xl font-semibold mb-4 text-gray-900">Generate Alt Text</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <p class="text-sm font-medium text-gray-700 mb-2">Image Preview</p>
                        <img id="modal-img" src="" alt="Image preview" class="rounded-lg w-full h-auto object-cover border border-gray-200">
                    </div>
                    <div id="modal-form">
                        <label for="alt-text-input" class="block text-sm font-medium text-gray-700 mb-2">AI Generated Alt Text</label>
                        <div id="modal-loader" class="flex items-center justify-center h-24 bg-gray-100 rounded-lg hidden">
                            <div class="loader"></div>
                            <p class="ml-4 text-gray-600">Generating with AI...</p>
                        </div>
                        <textarea id="alt-text-input" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="AI will generate text here..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">You can edit the generated text before applying.</p>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 rounded-b-2xl flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="modal-apply-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition" disabled>Apply to Webflow</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const connectBtn = document.getElementById('connect-btn');
            const apiKeyInput = document.getElementById('webflow-api-key');
            const connectionStatus = document.getElementById('connection-status');
            const siteSelectionSection = document.getElementById('site-selection-section');
            const siteSelector = document.getElementById('site-selector');
            const scanBtn = document.getElementById('scan-btn');
            const resultsSection = document.getElementById('results-section');
            const resultsGrid = document.getElementById('results-grid');
            const resultsLoader = document.getElementById('results-loader');
            const resultsSummary = document.getElementById('results-summary');
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            const modalImg = document.getElementById('modal-img');
            const modalForm = document.getElementById('modal-form');
            const modalLoader = document.getElementById('modal-loader');
            const altTextInput = document.getElementById('alt-text-input');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const modalApplyBtn = document.getElementById('modal-apply-btn');
            const toastContainer = document.getElementById('toast-container');

            // --- STATE ---
            let webflowApiKey = '';
            let selectedSiteId = '';
            let sites = [];
            let currentAsset = null;

            // --- LIVE WEBFLOW API ---
            // When running inside the Webflow Designer, a CORS proxy is not needed.
            const webflowApi = {
                listSites: async (apiKey) => {
                    const response = await fetch('https://api.webflow.com/v2/sites', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'accept': 'application/json'
                        }
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                },
                listAssets: async (apiKey, siteId) => {
                    const response = await fetch(`https://api.webflow.com/v2/sites/${siteId}/assets`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'accept': 'application/json',
                        }
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                },
                updateAsset: async (apiKey, siteId, assetId, newAltText) => {
                    const response = await fetch(`https://api.webflow.com/v2/sites/${siteId}/assets/${assetId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ alt: newAltText })
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                }
            };

            // --- GEMINI API ---
            const geminiApi = {
                generateAltText: async (base64ImageData) => {
                    const apiKey = ""; // Leave empty, will be handled by the environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const prompt = "You are an SEO and accessibility expert. Generate a concise, descriptive alt text for the following image. Do not start with 'Image of' or 'Picture of'. The alt text should be in English.";
                    
                    const payload = {
                        contents: [{
                            role: "user",
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: "image/png", data: base64ImageData } }
                            ]
                        }]
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`Gemini API error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text.trim();
                    } else {
                        console.error('Unexpected Gemini API response structure:', result);
                        throw new Error('Failed to generate alt text from AI.');
                    }
                }
            };

            // --- HELPER FUNCTIONS ---
            const showToast = (message, type = 'success') => {
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                const toast = document.createElement('div');
                toast.className = `toast text-white px-6 py-3 rounded-lg shadow-xl ${bgColor}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            };

            const imageUrlToBase64 = async (url) => {
                // Use a proxy for image fetching to avoid canvas tainting issues
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                 if (!response.ok) {
                     throw new Error(`Failed to fetch image through proxy: ${response.statusText}`);
                 }
                 const blob = await response.blob();
                 return new Promise((resolve, reject) => {
                     const reader = new FileReader();
                     reader.onloadend = () => resolve(reader.result.split(',')[1]);
                     reader.onerror = reject;
                     reader.readAsDataURL(blob);
                 });
            };

            // --- EVENT HANDLERS & LOGIC ---
            connectBtn.addEventListener('click', async () => {
                webflowApiKey = apiKeyInput.value;
                if (!webflowApiKey) {
                    showToast('Please enter a Webflow API key.', 'error');
                    return;
                }
                
                connectBtn.disabled = true;
                connectBtn.textContent = 'Connecting...';
                connectionStatus.textContent = 'Attempting to connect to Webflow...';
                connectionStatus.classList.remove('text-red-600', 'text-green-600');

                try {
                    const response = await webflowApi.listSites(webflowApiKey);
                    sites = response.sites;
                    
                    siteSelector.innerHTML = '<option value="">-- Select a site --</option>';
                    sites.forEach(site => {
                        const option = document.createElement('option');
                        option.value = site.id;
                        option.textContent = site.displayName;
                        siteSelector.appendChild(option);
                    });
                    
                    siteSelectionSection.classList.remove('hidden');
                    siteSelector.disabled = false;
                    connectionStatus.textContent = 'Successfully connected to Webflow!';
                    connectionStatus.classList.add('text-green-600');
                    showToast('Connection successful!');

                } catch (error) {
                    console.error('Connection failed:', error);
                    let errorMessage = `Connection failed: ${error.message}.`;
                    if (error.message.includes('403')) {
                        errorMessage += ' A 403 error often means the API Key is invalid or lacks permissions. Please double-check your key.';
                    } else if (error.message.includes('401')) {
                         errorMessage += ' A 401 error means you are not authorized. Please check your API key.';
                    }
                    else {
                        errorMessage += ' This may be a network or CORS proxy issue. Please try again.';
                    }
                    connectionStatus.textContent = errorMessage;
                    connectionStatus.classList.add('text-red-600');
                    showToast('Connection failed.', 'error');
                } finally {
                    connectBtn.disabled = false;
                    connectBtn.textContent = 'Connect';
                }
            });

            siteSelector.addEventListener('change', () => {
                selectedSiteId = siteSelector.value;
                scanBtn.disabled = !selectedSiteId;
                resultsSection.classList.add('hidden');
                resultsGrid.innerHTML = '';
            });

            scanBtn.addEventListener('click', async () => {
                if (!selectedSiteId) return;

                resultsSection.classList.remove('hidden');
                resultsGrid.innerHTML = '';
                resultsLoader.classList.remove('hidden');
                resultsSummary.textContent = '';
                scanBtn.disabled = true;
                scanBtn.textContent = 'Scanning...';

                try {
                    const response = await webflowApi.listAssets(webflowApiKey, selectedSiteId);
                    const allAssets = response.assets;
                    const imagesMissingAlt = allAssets.filter(asset => 
                        asset.contentType.startsWith('image/') && (!asset.alt || asset.alt.trim() === '')
                    );

                    resultsSummary.textContent = `Found ${imagesMissingAlt.length} images missing alt text out of ${allAssets.filter(a => a.contentType.startsWith('image/')).length} total images.`;

                    if (imagesMissingAlt.length === 0) {
                        resultsGrid.innerHTML = '<p class="text-center text-gray-500 col-span-full">Great job! All images have alt text.</p>';
                    } else {
                        imagesMissingAlt.forEach(asset => {
                            const card = document.createElement('div');
                            card.className = 'bg-gray-100 border border-gray-200 rounded-lg p-4 flex flex-col justify-between shadow-sm transition hover:shadow-md';
                            card.dataset.assetId = asset.id;
                            card.dataset.assetUrl = asset.url;
                            
                            card.innerHTML = `
                                <div>
                                    <img src="${asset.url}" alt="Missing alt text" class="w-full h-40 object-cover rounded-md mb-3 bg-gray-200" crossorigin="anonymous">
                                    <p class="text-xs text-gray-500 truncate" title="${asset.url.split('/').pop()}">${asset.url.split('/').pop()}</p>
                                </div>
                                <button class="generate-btn mt-4 w-full bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition text-sm">
                                    Generate Alt Text
                                </button>
                            `;
                            resultsGrid.appendChild(card);
                        });
                    }
                } catch (error) {
                    console.error('Failed to fetch assets:', error);
                    resultsSummary.textContent = `Could not fetch assets: ${error.message}. Please try again.`;
                    showToast('Failed to fetch assets.', 'error');
                } finally {
                    resultsLoader.classList.add('hidden');
                    scanBtn.disabled = false;
                    scanBtn.textContent = 'Scan for Images';
                }
            });

            resultsGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('generate-btn')) {
                    const card = e.target.closest('[data-asset-id]');
                    currentAsset = {
                        id: card.dataset.assetId,
                        url: card.dataset.assetUrl
                    };
                    openModal();
                }
            });

            const openModal = async () => {
                modal.classList.remove('hidden');
                modalImg.src = currentAsset.url;
                altTextInput.value = '';
                altTextInput.classList.add('hidden');
                modalLoader.classList.remove('hidden');
                modalApplyBtn.disabled = true;

                try {
                    const base64Image = await imageUrlToBase64(currentAsset.url);
                    const generatedText = await geminiApi.generateAltText(base64Image);
                    altTextInput.value = generatedText;
                } catch (error) {
                    console.error('AI generation failed:', error);
                    altTextInput.value = 'Sorry, could not generate alt text. Please write one manually.';
                    showToast('AI generation failed.', 'error');
                } finally {
                    modalLoader.classList.add('hidden');
                    altTextInput.classList.remove('hidden');
                    modalApplyBtn.disabled = false;
                }
            };

            const closeModal = () => {
                modal.classList.add('hidden');
                currentAsset = null;
            };

            modalCancelBtn.addEventListener('click', closeModal);

            modalApplyBtn.addEventListener('click', async () => {
                const newAltText = altTextInput.value;
                if (!newAltText || !currentAsset) return;

                modalApplyBtn.disabled = true;
                modalApplyBtn.textContent = 'Applying...';

                try {
                    await webflowApi.updateAsset(webflowApiKey, selectedSiteId, currentAsset.id, newAltText);
                    showToast('Alt text updated successfully!');
                    
                    // Remove the card from the UI
                    const cardToRemove = resultsGrid.querySelector(`[data-asset-id="${currentAsset.id}"]`);
                    if (cardToRemove) {
                        cardToRemove.style.transition = 'opacity 0.5s';
                        cardToRemove.style.opacity = '0';
                        setTimeout(() => {
                            cardToRemove.remove();
                             // Update summary after removing card
                            const remainingCards = resultsGrid.querySelectorAll('[data-asset-id]').length;
                            const totalImagesText = resultsSummary.textContent.match(/out of (\d+) total images/);
                            const totalImages = totalImagesText ? totalImagesText[1] : '?';
                            resultsSummary.textContent = `Found ${remainingCards} images missing alt text out of ${totalImages} total images.`;
                             if (remainingCards === 0) {
                                resultsGrid.innerHTML = '<p class="text-center text-gray-500 col-span-full">Great job! All images have alt text.</p>';
                            }
                        }, 500);
                    }
                    
                    closeModal();
                } catch (error) {
                    console.error('Failed to update asset:', error);
                    showToast(`Failed to update alt text: ${error.message}`, 'error');
                } finally {
                    modalApplyBtn.disabled = false;
                    modalApplyBtn.textContent = 'Apply to Webflow';
                }
            });
            
            // Close modal on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === "Escape" && !modal.classList.contains('hidden')) {
                    closeModal();
                }
            });

            // Close modal on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>
